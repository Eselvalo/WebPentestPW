<?php
session_start();

// Check if the user is not logged in
if (!isset($_SESSION['customer_id'])) {
  // Redirect the user to the login page
  header("Location: login.php");
  exit();
}

// Get the customer ID from the session
$customer_id = $_SESSION['customer_id'];

// Connect to the database
$host = 'localhost'; // replace with your MySQL hostname or IP address
$user = 'root'; // replace with your MySQL username
$password = ''; // replace with your MySQL password
$dbname = 'ecommerce'; // replace with your database name

$conn = new mysqli($host, $user, $password, $dbname);

// Check if the connection was successful
if ($conn->connect_error) {
  die("Connection failed: " . $conn->connect_error);
}

// Get the customer's information from the database
$stmt = $conn->prepare("SELECT name, email FROM customers WHERE id = ?");
$stmt->bind_param("i", $customer_id);
$stmt->execute();
$result = $stmt->get_result();

// Check if the query returned a record
if ($result->num_rows == 1) {
  $row = $result->fetch_assoc();
  $customer_name = $row['name'];
  $customer_email = $row['email'];
} else {
  // Redirect the user to the login page if the customer record wasn't found
  header("Location: login.php");
  exit();
}

// Handle form submission
if ($_SERVER['REQUEST_METHOD'] == 'POST') {
  $new_email = $_POST['new_email'];
  $new_password = $_POST['new_password'];

  // Update the customer's email and password in the database
  $stmt = $conn->prepare("UPDATE customers SET email = ?, password = ? WHERE id = ?");
  $stmt->bind_param("ssi", $new_email, $new_password, $customer_id);
  $stmt->execute();

  // Store the new email in the session
  $_SESSION['customer_email'] = $new_email;

  // Redirect the user back to the profile page
  header("Location: profile.php");
  exit();
}

// Close the database connection and statement
$stmt->close();
$conn->close();
?>

<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile</title>
    <link rel="stylesheet" href="../style.css">
</head>
<body>
<header>
        <div style=" display: flex; justify-content: center;">
            <img src="../img/logo_png.png" style="max-height: 100px;" alt="">
        </div>
        <nav>
            
            <div class="searchbar">
                <input style="background-color: #f5ad72; border: solid 0px ;" type="text" placeholder="Search...">
                <button style=" color: white;">Search</button>
            </div>
            <div class="profile">
                <img style="border-radius: 80px; max-width: 50px; margin:3px; border: solid 2px white;" src="../img/Profile.jpg" href="#"></img>
            </div>
        </nav>
    </header>
    <div class="my-info">
    <h1>Profile Page</h1>
  <h2>Welcome <?php echo $customer_name; ?>!</h2>
  <p>You can update your email and password below:</p>
  <form style="display: flex; flex-direction: column; padding-bottom: 20px; padding-top: 20px;" method="post" action="<?php echo htmlspecialchars($_SERVER['PHP_SELF']); ?>">
    <label for="new_email">New Email:</label>
    <input style="margin: 20px;  margin-left: 0px; border-radius: 5px; max-width: 400px; min-height: 40px; padding: 5px;" type="email" id="new_email" name="new_email" value="<?php echo $customer_email; ?>"><br>
    <label for="new_password">New Password:</label>
    <input style="margin: 20px; margin-left: 0px; border-radius: 5px; max-width: 400px; min-height: 40px; padding: 5px;" type="password" id="new_password" name="new_password"><br>
    <button  class="button" style=" min-height:50px ; width: 100px;" type="submit">Update</button>
  </form>
  <div style="display: flex; flex-direction:row; ">
    <form style="padding-bottom: 20px; padding-top: 20px; margin: auto;" action="logout.php" method="post">
         <button  class="button" style=" min-height:50px; width: 100px;" type="submit" name="logout">Logout</button>
    </form>
    <form style="padding-bottom: 20px; padding-top: 20px; margin: auto;" action="index.php" method="post">
         <button class="button" style=" min-height:50px ; width: 100px;" type="submit" name="home">Home</button>
    </form>
  </div>
    </div>
  <main>
        <section class="my-info">
            <h2>My Info</h2>
            <img style="border-radius: 80px; width: 160px;" src="../img/Profile.jpg" alt="Profile image">
            <p>Name:  <?php echo $customer_name; ?></p>
            <p>Email: <?php echo $customer_email; ?></p>
        </section>
        <section class="my-balance">
            <h2>My Balance</h2>
            <p>$250.00</p>
        </section>
        <section class="my-wallet">
            <h2>My Wallet</h2>
            <p>Payment Method: **** **** **** 1234</p>
        </section>
        <section class="featured-products">
            <h2>Recent orders</h2>
            <div class="product-grid">
                <div class="product-card">
                    <img src="../img/product1.jpg" alt="Product 1">
                    <h3>Product 1</h3>
                    <p>$10.00</p>
                </div>
                <div class="product-card">
                    <img src="../img/product2.jpg" alt="Product 2">
                    <h3>Product 2</h3>
                    <p>$15.00</p>
                </div>
                <div class="product-card">
                    <img src="../img/product3.jpg" alt="Product 3">
                    <h3>Product 3</h3>
                    <p>$20.00</p>
                </div>
                <div class="product-card">
                    <img src="../img/product4.jpg" alt="Product 4">
                    <h3>Product 4</h3>
                    <p>$25.00</p>
                </div>
            </div>
        </section>
    </main>
    <footer>
        <p>&copy; 2023 E-commerce Website. All rights reserved.</p>
    </footer>
</body>
</html>
