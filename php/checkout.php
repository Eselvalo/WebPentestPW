<?php
session_start();

// Check if the user is not logged in
if (!isset($_SESSION['customer_id'])) {
  // Redirect the user to the login page
  header("Location: login.php");
  exit();
}

// Get the customer ID from the session
$customer_id = $_SESSION['customer_id'];

// Connect to the database
$host = 'localhost'; // replace with your MySQL hostname or IP address
$user = 'root'; // replace with your MySQL username
$password = ''; // replace with your MySQL password
$dbname = 'ecommerce'; // replace with your database name

$conn = new mysqli($host, $user, $password, $dbname);

// Check if the connection was successful
if ($conn->connect_error) {
  die("Connection failed: " . $conn->connect_error);
}

// Calculate the total price of the order
$total = 0;
foreach ($_SESSION['cart'] as $product_id => $quantity) {
  $result = $conn->query("SELECT price FROM products WHERE id = $product_id");
  $row = $result->fetch_assoc();
  $total += (float)$row['price'] * (int)$quantity;
}

// Insert a new record into the orders table
$result = $conn->query("INSERT INTO orders (customer_id, total, date, status) VALUES ($customer_id, $total, NOW(), 'pending')");
$order_id = $conn->insert_id; // Get the ID of the newly inserted order

// Insert a new record into the order_items table for each item in the cart
foreach ($_SESSION['cart'] as $product_id => $quantity) {
  $product_id = (int)$product_id;
  $quantity = (int)$quantity;
  $conn->query("INSERT INTO order_items (order_id, product_id, quantity) VALUES ($order_id, $product_id, $quantity)");
}

// Clear the cart
$_SESSION['cart'] = [];

// Close the database connection
$conn->close();

// Redirect the user to the orders page
header("Location: orders.php");
exit();
?>
