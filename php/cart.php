<?php
session_start();

// Check if the form was submitted via a POST request
if ($_SERVER['REQUEST_METHOD'] == 'POST') {
  $product_id = $_POST['product_id'];
  $quantity = $_POST['quantity'];

  // Add the item to the cart
  if (!isset($_SESSION['cart'])) {
    $_SESSION['cart'] = array();
  }
  if (!isset($_SESSION['cart'][$product_id])) {
    $_SESSION['cart'][$product_id] = array();
    $_SESSION['cart'][$product_id]['quantity'] = 0;
  }
  $_SESSION['cart'][$product_id]['quantity'] += $quantity;

  // Redirect the user to the cart page
  header("Location: cart.php");
  exit();
}

// Check if the cart is empty
if (empty($_SESSION['cart'])) {
  echo "Your cart is empty.";
  exit();
}

// Connect to the database
$host = 'localhost'; // replace with your MySQL hostname or IP address
$user = 'root'; // replace with your MySQL username
$password = ''; // replace with your MySQL password
$dbname = 'ecommerce'; // replace with your database name

$conn = mysqli_connect($host, $user, $password, $dbname);

// Check if the connection was successful
if (mysqli_connect_errno()) {
  die("Connection failed: " . mysqli_connect_error());
}

// Retrieve the product information for the items in the cart
$sql = "SELECT id, name, price FROM products WHERE id IN (" . implode(",", array_keys($_SESSION['cart'])) . ")";
$result = mysqli_query($conn, $sql);

// Build an array of product information with the cart quantity
$cart_items = array();
while ($row = mysqli_fetch_assoc($result)) {
  $product_id = $row['id'];
  $product_name = $row['name'];
  $product_price = $row['price'];
  $cart_quantity = $_SESSION['cart'][$product_id]['quantity'];
  $cart_items[$product_id] = array(
    'name' => $product_name,
    'price' => $product_price,
    'quantity' => $cart_quantity
  );
}

// Close the database connection
mysqli_close($conn);
?>

<!DOCTYPE html>
<html>
<head>
  <title>My Cart</title>
</head>
<body>
  <h1>My Cart</h1>
  <table>
    <tr>
      <th>Product</th>
      <th>Price</th>
      <th>Quantity</th>
      <th>Total</th>
    </tr>
    <?php foreach ($cart_items as $product_id => $product) { ?>
      <tr>
        <td><?php echo $product['name']; ?></td>
        <td>$<?php echo number_format($product['price'], 2); ?></td>
        <td><?php echo $product['quantity']; ?></td>
        <td>$<?php echo number_format($product['price'] * $product['quantity'], 2); ?></td>
        <td>
            <form method="post" action="remove_from_cart.php">
                <input type="hidden" name="product_id" value="<?php echo $product_id; ?>">
                <input type="submit" value="Remove">
            </form>
        </td>
      </tr>
    <?php } ?>
    <tr>
      <td colspan="3">Total:</td>
      <td>$<?php
        $total = 0;
        foreach ($cart_items as $product) {
          $total += $product['price'] * $product['quantity'];
        }
        echo number_format($total, 2);
      ?></td>
    </tr>
  </table>
    <form method="post" action="products.php">
        <input type="submit" value="Continue Shopping">
    </form>
    <form method="post" action="checkout.php">
        <input type="submit" value="Checkout">
    </form>
    <form action="index.php" method="post">
        <button type="submit" name="home">Home</button>
    </form>

</body>
</html>
